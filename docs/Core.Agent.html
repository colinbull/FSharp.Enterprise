<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>F# Enterprise: Library for Enterprise Development
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="The F# Enterprise library. Provides helpers for a range of common enterprise development scenarios">
    <meta name="author" content="Colin Bull">

    <script src="http://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="http://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet">

    <link type="text/css" rel="stylesheet" href="content/style.css" />
    <script src="content/tips.js" type="text/javascript"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="http://fsharp.org">fsharp.org</a></li>
		  <li><a href="http://github.com/colinbull/FSharp.Enterprise">github page</a></li>
          <li><a href="http://github.com/tpetricek/FSharp.Data">fsharp.data library</a></li>
          <li><a href="http://fsharp.github.com/fsharpx/">fsharpx library</a></li>
        </ul>
        <h3 class="muted">F# Enterprise Library</h3>
      </div>
      <hr />
      <div class="row">
        <div class="span9" id="main">
          <h1>F# Enterprise - Agents</h1>

<p>The following sample demonstrates the <code>FSharp.Enterprise.Agents</code> module. Agents are a powerful pattern and
can make asyncronous programming far easier by encapsulating the computation. Communication with agents 
is achieved via passing messages to the instances of the agent. This agent can optionally mutate some internal state
or pass the result of the computation to another agent via another message. To this end entire networks of agents 
can be created.</p>
<pre class="fssnip">
<span class="l">1: </span><span class="prep">#r</span> <span class="s">@&quot;</span><span class="s">.</span><span class="s">.</span><span class="s">\</span><span class="s">bin</span><span class="s">\</span><span class="s">FSharp</span><span class="s">.</span><span class="s">Enterprise</span><span class="s">.</span><span class="s">dll</span><span class="s">&quot;</span>
<span class="l">2: </span>
<span class="l">3: </span><span class="k">open</span> <span onmouseout="hideTip(event, 'fs1', 1)" onmouseover="showTip(event, 'fs1', 1)" class="i">System</span>
<span class="l">4: </span><span class="k">open</span> <span onmouseout="hideTip(event, 'fs2', 2)" onmouseover="showTip(event, 'fs2', 2)" class="i">FSharp</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs3', 3)" onmouseover="showTip(event, 'fs3', 3)" class="i">Enterprise</span></pre>
<h3>Creating a simple agent</h3>

<p>In this example we create a simple agent that accepts a string and just prints the received message out to the console.</p>
<pre class="fssnip">
<span class="l">1: </span><span class="k">let</span> <span onmouseout="hideTip(event, 'fs4', 4)" onmouseover="showTip(event, 'fs4', 4)" class="i">simpleAgent</span> <span class="o">=</span> 
<span class="l">2: </span>    <span onmouseout="hideTip(event, 'fs5', 5)" onmouseover="showTip(event, 'fs5', 5)" class="i">Agent</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs6', 6)" onmouseover="showTip(event, 'fs6', 6)" class="i">bind</span> (<span onmouseout="hideTip(event, 'fs5', 7)" onmouseover="showTip(event, 'fs5', 7)" class="i">Agent</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs7', 8)" onmouseover="showTip(event, 'fs7', 8)" class="i">receive</span> 
<span class="l">3: </span>            (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs8', 9)" onmouseover="showTip(event, 'fs8', 9)" class="i">msg</span> <span class="k">-&gt;</span> 
<span class="l">4: </span>                 <span onmouseout="hideTip(event, 'fs9', 10)" onmouseover="showTip(event, 'fs9', 10)" class="i">async</span> {
<span class="l">5: </span>                    <span class="k">do</span> <span onmouseout="hideTip(event, 'fs10', 11)" onmouseover="showTip(event, 'fs10', 11)" class="i">printfn</span> <span class="s">&quot;</span><span class="s">Recieved</span><span class="s"> </span><span class="s">message</span><span class="s"> </span><span class="s">%</span><span class="s">s</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs8', 12)" onmouseover="showTip(event, 'fs8', 12)" class="i">msg</span>
<span class="l">6: </span>                 }
<span class="l">7: </span>            ))</pre>
<p>This example uses the bind and recieve combinators. This is a common pattern and thus the library also has the 'Agent.reciever' combinator
(from now on I will use the wrapped varients)</p>

<p>Each agent is given an id (by default this is <code>Guid.NewGuid()</code>) but this can be set when creating the agent using <code>Agent.bindNamed</code> 
or after the agent is created using the <code>Agent.named</code> combinator.</p>

<p>When using <code>MailboxProcessor&lt;'a&gt;</code> we have several methods available to select how we recieve messages. Scan, Recieve (see above) and TryReceive
within <code>FSharp.Enterprise.Agents</code> there are analogous combinators for these methods.</p>
<pre class="fssnip">
<span class="l"> 1: </span><span class="k">let</span> <span onmouseout="hideTip(event, 'fs11', 13)" onmouseover="showTip(event, 'fs11', 13)" class="i">ifGreaterThan5</span> <span class="o">=</span> 
<span class="l"> 2: </span>    (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs12', 14)" onmouseover="showTip(event, 'fs12', 14)" class="i">msg</span> <span class="k">-&gt;</span> 
<span class="l"> 3: </span>        <span class="k">match</span> <span onmouseout="hideTip(event, 'fs12', 15)" onmouseover="showTip(event, 'fs12', 15)" class="i">msg</span> <span class="k">with</span>
<span class="l"> 4: </span>        | <span onmouseout="hideTip(event, 'fs13', 16)" onmouseover="showTip(event, 'fs13', 16)" class="i">a</span> <span class="k">when</span> <span onmouseout="hideTip(event, 'fs13', 17)" onmouseover="showTip(event, 'fs13', 17)" class="i">a</span> <span class="o">&gt;</span><span class="o">=</span> <span class="n">5</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs9', 18)" onmouseover="showTip(event, 'fs9', 18)" class="i">async</span> { <span class="k">return</span> <span onmouseout="hideTip(event, 'fs12', 19)" onmouseover="showTip(event, 'fs12', 19)" class="i">msg</span> } <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs14', 20)" onmouseover="showTip(event, 'fs14', 20)" class="i">Some</span>
<span class="l"> 5: </span>        | _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs15', 21)" onmouseover="showTip(event, 'fs15', 21)" class="i">None</span>)
<span class="l"> 6: </span>
<span class="l"> 7: </span><span class="k">let</span> <span onmouseout="hideTip(event, 'fs16', 22)" onmouseover="showTip(event, 'fs16', 22)" class="i">greaterThan5</span> <span class="o">=</span> 
<span class="l"> 8: </span>    <span onmouseout="hideTip(event, 'fs5', 23)" onmouseover="showTip(event, 'fs5', 23)" class="i">Agent</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs17', 24)" onmouseover="showTip(event, 'fs17', 24)" class="i">scanner</span> <span onmouseout="hideTip(event, 'fs11', 25)" onmouseover="showTip(event, 'fs11', 25)" class="i">ifGreaterThan5</span>
<span class="l"> 9: </span>     (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs12', 26)" onmouseover="showTip(event, 'fs12', 26)" class="i">msg</span> <span class="k">-&gt;</span> 
<span class="l">10: </span>         <span onmouseout="hideTip(event, 'fs9', 27)" onmouseover="showTip(event, 'fs9', 27)" class="i">async</span> {
<span class="l">11: </span>            <span class="k">do</span> <span onmouseout="hideTip(event, 'fs10', 28)" onmouseover="showTip(event, 'fs10', 28)" class="i">printfn</span> <span class="s">&quot;</span><span class="s">Recieved</span><span class="s"> </span><span class="s">message</span><span class="s"> </span><span class="s">%</span><span class="s">d</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs12', 29)" onmouseover="showTip(event, 'fs12', 29)" class="i">msg</span>
<span class="l">12: </span>         })</pre>
<p>Above we defined a selector to filter the incoming messages if the value of msg > 5. This is then passed into the
<code>Agent.scanner</code> function along with the actual body to pass the message onto if the predicate passes.</p>

<h3>Handling Errors</h3>

<p>Error handling is always an important part of any enterprise application. With agents it is no different. However because
agents are asyncronous errors are materialised via an event.</p>
<pre class="fssnip">
<span class="l">1: </span><span class="k">let</span> <span onmouseout="hideTip(event, 'fs18', 30)" onmouseover="showTip(event, 'fs18', 30)" class="i">simpleAgentWithErrorHandling</span> <span class="o">=</span> 
<span class="l">2: </span>    <span onmouseout="hideTip(event, 'fs4', 31)" onmouseover="showTip(event, 'fs4', 31)" class="i">simpleAgent</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs5', 32)" onmouseover="showTip(event, 'fs5', 32)" class="i">Agent</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs19', 33)" onmouseover="showTip(event, 'fs19', 33)" class="i">onError</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs20', 34)" onmouseover="showTip(event, 'fs20', 34)" class="i">agent</span> <span onmouseout="hideTip(event, 'fs21', 35)" onmouseover="showTip(event, 'fs21', 35)" class="i">err</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs10', 36)" onmouseover="showTip(event, 'fs10', 36)" class="i">printfn</span> <span class="s">&quot;</span><span class="s">Agent</span><span class="s"> </span><span class="s">%</span><span class="s">s</span><span class="s"> </span><span class="s">errored</span><span class="s">:</span><span class="s">\r</span><span class="s">\n</span><span class="s">%</span><span class="s">s</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs20', 37)" onmouseover="showTip(event, 'fs20', 37)" class="i">agent</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs22', 38)" onmouseover="showTip(event, 'fs22', 38)" class="i">Id</span> <span onmouseout="hideTip(event, 'fs21', 39)" onmouseover="showTip(event, 'fs21', 39)" class="i">err</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs23', 40)" onmouseover="showTip(event, 'fs23', 40)" class="i">Message</span>)</pre>
<h3>A higher order agent.</h3>

<p>Below we define an agent that has the same behaviour as the scanning agent above, however here we build the same filtering behaviour 
by combining several combinators and the simple agent we defined above. Additionally we can intercept the messages going through the pipeline.
 In this sense we can create <em>higher order</em> agents by combining several other simple agents.</p>
<pre class="fssnip">
<span class="l">1: </span><span class="k">let</span> <span onmouseout="hideTip(event, 'fs24', 41)" onmouseover="showTip(event, 'fs24', 41)" class="i">complexAgent</span> <span class="o">=</span> 
<span class="l">2: </span>    <span onmouseout="hideTip(event, 'fs4', 42)" onmouseover="showTip(event, 'fs4', 42)" class="i">simpleAgent</span>
<span class="l">3: </span>    <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs5', 43)" onmouseover="showTip(event, 'fs5', 43)" class="i">Agent</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs25', 44)" onmouseover="showTip(event, 'fs25', 44)" class="i">map</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs26', 45)" onmouseover="showTip(event, 'fs26', 45)" class="i">x</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs26', 46)" onmouseover="showTip(event, 'fs26', 46)" class="i">x</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs27', 47)" onmouseover="showTip(event, 'fs27', 47)" class="i">ToString</span>())
<span class="l">4: </span>    <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs5', 48)" onmouseover="showTip(event, 'fs5', 48)" class="i">Agent</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs28', 49)" onmouseover="showTip(event, 'fs28', 49)" class="i">filter</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs26', 50)" onmouseover="showTip(event, 'fs26', 50)" class="i">x</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs26', 51)" onmouseover="showTip(event, 'fs26', 51)" class="i">x</span> <span class="o">&gt;</span><span class="o">=</span> <span class="n">5</span>)
<span class="l">5: </span>    <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs5', 52)" onmouseover="showTip(event, 'fs5', 52)" class="i">Agent</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs29', 53)" onmouseover="showTip(event, 'fs29', 53)" class="i">intercept</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs26', 54)" onmouseover="showTip(event, 'fs26', 54)" class="i">x</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs9', 55)" onmouseover="showTip(event, 'fs9', 55)" class="i">async</span> { <span class="k">do</span> <span onmouseout="hideTip(event, 'fs10', 56)" onmouseover="showTip(event, 'fs10', 56)" class="i">printfn</span> <span class="s">&quot;</span><span class="s">Intercept</span><span class="s">:</span><span class="s"> </span><span class="s">%</span><span class="s">A</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs26', 57)" onmouseover="showTip(event, 'fs26', 57)" class="i">x</span> })
<span class="l">6: </span>
<span class="l">7: </span><span onmouseout="hideTip(event, 'fs24', 58)" onmouseover="showTip(event, 'fs24', 58)" class="i">complexAgent</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs30', 59)" onmouseover="showTip(event, 'fs30', 59)" class="i">Post</span>(<span class="n">6</span>)
<span class="l">8: </span><span onmouseout="hideTip(event, 'fs24', 60)" onmouseover="showTip(event, 'fs24', 60)" class="i">complexAgent</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs30', 61)" onmouseover="showTip(event, 'fs30', 61)" class="i">Post</span>(<span class="n">4</span>)</pre>

          <div class="tip" id="fs1">namespace System</div>
<div class="tip" id="fs2">namespace FSharp</div>
<div class="tip" id="fs3">namespace FSharp.Enterprise</div>
<div class="tip" id="fs4">val simpleAgent : IAgent&lt;string&gt;<br /><br />Full name: Core.Agent.simpleAgent</div>
<div class="tip" id="fs5">Multiple items<br />module Agent<br /><br />from FSharp.Enterprise<br /><br />--------------------<br />type Agent&lt;&#39;a&gt; = MailboxProcessor&lt;&#39;a&gt;<br /><br />Full name: FSharp.Enterprise.Agent&lt;_&gt;</div>
<div class="tip" id="fs6">val bind : agent:(IAgent&lt;&#39;a&gt; -&gt; Async&lt;unit&gt;) -&gt; IAgent&lt;&#39;a&gt;<br /><br />Full name: FSharp.Enterprise.Agent.bind</div>
<div class="tip" id="fs7">val receive : agentBody:(&#39;a -&gt; Async&lt;unit&gt;) -&gt; (IAgent&lt;&#39;a&gt; -&gt; Async&lt;&#39;b&gt;)<br /><br />Full name: FSharp.Enterprise.Agent.receive</div>
<div class="tip" id="fs8">val msg : string</div>
<div class="tip" id="fs9">val async : AsyncBuilder<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.async</div>
<div class="tip" id="fs10">val printfn : format:Printf.TextWriterFormat&lt;&#39;T&gt; -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.printfn</div>
<div class="tip" id="fs11">val ifGreaterThan5 : msg:int -&gt; Async&lt;int&gt; option<br /><br />Full name: Core.Agent.ifGreaterThan5</div>
<div class="tip" id="fs12">val msg : int</div>
<div class="tip" id="fs13">val a : int</div>
<div class="tip" id="fs14">union case Option.Some: &#39;T -&gt; Option&lt;&#39;T&gt;</div>
<div class="tip" id="fs15">union case Option.None: Option&lt;&#39;T&gt;</div>
<div class="tip" id="fs16">val greaterThan5 : IAgent&lt;int&gt;<br /><br />Full name: Core.Agent.greaterThan5</div>
<div class="tip" id="fs17">val scanner : scanner:(&#39;msg -&gt; Async&lt;&#39;msg&gt; option) -&gt; agentBody:(&#39;msg -&gt; Async&lt;unit&gt;) -&gt; IAgent&lt;&#39;msg&gt;<br /><br />Full name: FSharp.Enterprise.Agent.scanner</div>
<div class="tip" id="fs18">val simpleAgentWithErrorHandling : IAgent&lt;string&gt;<br /><br />Full name: Core.Agent.simpleAgentWithErrorHandling</div>
<div class="tip" id="fs19">val onError : handler:(IAgent&lt;&#39;msg&gt; -&gt; exn -&gt; unit) -&gt; agent:IAgent&lt;&#39;msg&gt; -&gt; IAgent&lt;&#39;msg&gt;<br /><br />Full name: FSharp.Enterprise.Agent.onError</div>
<div class="tip" id="fs20">val agent : IAgent&lt;string&gt;</div>
<div class="tip" id="fs21">val err : exn</div>
<div class="tip" id="fs22">property IAgent.Id: string</div>
<div class="tip" id="fs23">property Exception.Message: string</div>
<div class="tip" id="fs24">val complexAgent : IAgent&lt;int&gt;<br /><br />Full name: Core.Agent.complexAgent</div>
<div class="tip" id="fs25">val map : f:(&#39;a -&gt; &#39;b) -&gt; agent:IAgent&lt;&#39;b&gt; -&gt; IAgent&lt;&#39;a&gt;<br /><br />Full name: FSharp.Enterprise.Agent.map</div>
<div class="tip" id="fs26">val x : int</div>
<div class="tip" id="fs27">Int32.ToString() : string<br />Int32.ToString(provider: IFormatProvider) : string<br />Int32.ToString(format: string) : string<br />Int32.ToString(format: string, provider: IFormatProvider) : string</div>
<div class="tip" id="fs28">val filter : f:(&#39;a -&gt; bool) -&gt; agent:IAgent&lt;&#39;a&gt; -&gt; IAgent&lt;&#39;a&gt;<br /><br />Full name: FSharp.Enterprise.Agent.filter</div>
<div class="tip" id="fs29">val intercept : f:(&#39;msg -&gt; Async&lt;unit&gt;) -&gt; agent:IAgent&lt;&#39;msg&gt; -&gt; IAgent&lt;&#39;msg&gt;<br /><br />Full name: FSharp.Enterprise.Agent.intercept</div>
<div class="tip" id="fs30">abstract member Channel.IChannel.Post : &#39;a -&gt; unit</div>

        </div>
        <div class="span3">

          <ul class="nav nav-list" id="menu">
            <li class="nav-header">F# Enterprise Library</li>
            <li><a href="Index.html">Home page</a></li>
            <li class="divider"></li>
            <li><a href="https://nuget.org/packages/FSharp.Enterprise">Get Library via NuGet</a></li>
            <li><a href="https://github.com/colinbull/FSharp.Enterprise">Source Code on GitHub</a></li>
            <li><a href="https://github.com/colinbull/FSharp.Enterprise/blob/master/LICENSE.md">License (Apache 2.0)</a></li>
            
            <li class="nav-header">Documentation</li>
            <li><a href="Index.html">F# Enterprise Library</a></li>
            <li class="divider"></li>
          </ul>

        </div>
      </div>
    </div>
    <a href="https://github.com/colinbull/FSharp.Enterprise"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png" alt="Fork me on GitHub"></a>
  </body>
  </html>